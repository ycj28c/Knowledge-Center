Shard知识点

## 什么是sharding（分片）
通常来说，分片（Sharding）是一种与水平切分（horizontal partitioning）相关的数据库架构模式——将一个表里面的行，分成多个不同的表的做法（称为分区）。每个区都具有相同的模式和列，但每个表有完全不同的行。同样，每个分区中保存的数据都是唯一的，并且与其他分区中保存的数据无关。

分片主要是针对SQL来说的，因为NoSQL就是这么设计的，每一个Node就相当于一个Shard。

## Sharding和Partition的区别
Sharding不是一个某个特定数据库软件附属的功能，而是在具体技术细节之上的抽象处理，是水平扩展(Scale Out，亦或横向扩展、向外扩展)的解决方案，其主要目的是为突破单节点数据库服务器的 I/O 能力限制，解决数据库扩展性问题。

而Partition就是具体的技术，有水平切分（horizontal partitioning单表均分）与垂直切分（virtical partitioning按照column切分），在垂直切分表中，所有的列被分离出来，并放入新的不同的表中。每个垂直切分内的数据，独立于所有其他分区中的数据，并且每个分区都包含不同的行和列。

## 怎么Sharding，策略
这个Sharding是需要根据具体业务的，比如按照Region进行分区，应用就根据RegionId去访问不同的数据库分区。

分片（Sharding）在应用程序级别进行实现。这意味着应用程序包含“要向哪个分片发送读和写”的代码。但是，某些数据库管理系统内置了分片功能，允许您直接在数据库级别实现分片。

1)通过Key Based Sharding基于键的分片  
就是使用Hash对key进行hash，最简单就是mod啦。比如key % 2

比如一个表
| column1 | column2 | column3 |
|---------|---------|---------|
| 1       |         |         |
| 2       |         |         |
| 3       |         |         |
| 4       |         |         |

Shard 1
| column1 | column2 | column3 |
|---------|---------|---------|
| 1       |         |         |
| 3       |         |         |

Shard 2
| column1 | column2 | column3 |
|---------|---------|---------|
| 2       |         |         |
| 4       |         |         |

2)通过范围分片  
比如这个商品价格表

| Product | Price | 
|---------|---------|
| WIDET   |   116   | 
| GIZMO   |   88    | 
| DOODAD  |   37    |  
| TRINKET |   16    |  

按照价格分片  
$0 - $100
| Product | Price | 
|---------|---------|
| GIZMO   |   88    | 
| DOODAD  |   37    |  
| TRINKET |   16    | 

$100 - $200
| Product | Price | 
|---------|---------|
| WIDET   |   116   | 


## Sharding优缺点
优点：  
分散负载，提高throughput，加快响应，减少了整体宕机时间(宕机可能只会影响单个分片)。

1) 选择分片数据库架构的另一个原因，是为了加速查询响应的时间。当您对尚未分片的数据库提交查询时，必须先搜索您查询的表中的每一行，然后才能找到您要查找的结果集。对于具有大型单片数据库的应用程序，查询可能变得极其缓慢。但是，通过将一个表分成多个，查询过程会遍历更少的行，并且返回结果集的速度要快得多。

2) 分片还可以通过减少宕机（outage）的影响，使应用程序更稳定可靠。如果您的应用程序或网站依赖于未分片的数据库，则宕机可能会导致整个应用程序不可用。但是，对于分片数据库，宕机可能只会影响单个分片。即使这可能使某些用户无法使用应用程序或网站部分功能，但仍会低于整个数据库崩溃带来的影响。

缺点：  
实现较复杂，管理也复杂，对于热点数据还需要细分。

1) 正确实现分片数据库架构，是十分复杂的，所以这是分片遇到的第一个困难。如果操作不正确，则分片过程可能会导致数据丢失或表损坏，这是一个很大的风险。但是，即使正确地进行了分片，也可能对团队的工作流程产生重大影响。与从单个入口点访问和管理数据不同，用户必须跨多个分片位置管理数据，这可能会让某些团队存在工作混乱。

2) 在对数据库进行分片后，用户有时会遇到的一个问题是分片最终会变得不平衡。举例来说，假设您有一个数据库，其中有两个单独的分片，一个用于姓氏以字母A到M开头的客户，另一个用于名字以字母N到Z开头的客户。但是，您的应用程序为姓氏以字母G开头的人提供了过多的服务。因此，A-M分片逐渐累积的数据比N-Z分片要多，这会导致应用程序速度变慢，并对很大一部分用户造成影响。A-M分片已成为所谓的数据热点。在这种情况下，数据库分片的任何好处都被慢速和崩溃抵消了。数据库可能需要修复和重新分片，才能实现更均匀的数据分布。

3) 另一个主要缺点是，一旦对数据库进行了分片，就很难将其恢复到未分片的架构。分片前数据库的备份数据，都无法与分片后写入的数据合并。因此，重建原始的非分片架构，需要将新的分区数据与旧备份合并，或者将分区的数据库转换回单个数据库，这两种方法都是昂贵且耗时的。

4) 要考虑的最后一个缺点是，并不是每个数据库引擎本身都支持分片。例如，尽管可以手动分片PostgreSQL数据库，但PostgreSQL本身并不包括自动分片功能。有许多Postgres分支包括自动分片功能，但这些分支通常落后于最新的PostgreSQL版本，并且缺乏某些其他的功能特性。一些专业的数据库技术——如MySQL Cluster或某些数据库即服务产品（如MongoDB Atlas）确实包含自动分片功能，但这些数据库管理系统的普通版本却并不包含。因此，分片通常需要“自己动手”的方法。这意味着通常很难找到有关分片或故障排除技巧的文档

## 什么时候需要Sharding  
1.单表或者单库数据量过大，比如超过2M数据量就性能下降。  
2.数据库读写过大，需要分流（这个应该也可以读写分离）  
3.网络上的限制，数据传输量超过单点网络带宽（bandwidth）  

通常Sharding是大招，在之前可以先尝试其他解决方案，比如:  
1.加入缓存进行优化  
2.一主带多重，多个只读副本replica  
3.提高单机性能  

ps：其实关系型数据库比如MySQL也有集群，比如MySQL cluster，但是用法是不一样的，比如只能使用存储引擎 NDB，一个事务在提交前查询不到在事务内所做的修改，外键支持性能不好。作为分布式的数据库系统，各个节点之间存在大量的数据通讯，比如所有访问都是需要经过超过一个节点（至少有一个 SQL Node和一个 NDB Node）才能完成，因此对节点之间的内部互联网络带宽要求高等问题。

## 分片的管理
查询服务如何知道与哪个分片进行通信以检索数据？ 如果你正在考虑一个中间件，那么就走对了。 一种解决方案是将代理（如负载平衡器）放置在查询服务和数据库的前面。 在引擎盖下，负载平衡器依赖于诸如ZooKeeper之类的配置服务来跟踪分片及其索引。 通过处理查询，负载均衡器将确切知道将请求定向到哪个分片。
```
Query service -- > Cluster Proxy(LB) ----------- > ShardA(A-F)
                        |            ----------- > ShardB(G-L)
                        |            ----------- > ShardC(M-Z)
                   Configuration Service (Zookeeper)     
```
这个LB可以是用户自己写的Cluster Proxy/Shard Service，需要满足自己的分片逻辑，比如根据首字母Range分片。  
分区的配置文件通过Zookeeper统一管理，Zookeeper既保证配置文件一致，又可以监控机器在线退出和master，是个分布式强一致存储。

## Reference
1.[数据库分片（Database Sharding)详解](https://zhuanlan.zhihu.com/p/57185574)  
2.[MongoDB Shard Keys](https://docs.mongodb.com/manual/core/sharding-shard-key/#sharding-shard-key-selection)  
3.[多图文，详细介绍mysql各个集群方案](https://blog.csdn.net/weixin_43750212/article/details/104778156)  
4.[mysql分片、分区、分表、分库](https://blog.51cto.com/net881004/2109383)  
5.[怎么扩展数据库和Nosql数据库——系统设计](https://zhuanlan.zhihu.com/p/139214419)




